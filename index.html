<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div class="abc" style="border: 1px solid red; padding: 20px; width: max-content;">
        this is card
    </div>
    <div>
        <div>
            Hello
        </div>
        <li>
            Hello
        </li>
        Hello
    </div>
    <p>
        Hello
    </p>
    <div>
        Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet dolore
        accusamus
        voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta ipsa!
        Adipisci, vero!
    </div>
    <div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <hr />
        <hr />
        <hr />
        <hr />
        <hr />
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <hr />
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
        <div>
            Lorem hi ipsum Hello dolor sit, amet consectetur adipisicing elit. Quibusdam, aliquid eligendi eveniet
            dolore
            accusamus
            voluptatibus, vitae cumque perspiciatis minima quas totam aut corrupti corporis praesentium possimus dicta
            ipsa!
            Adipisci, vero!
        </div>
    </div>
</body>

<script>
    async function wait(time) {
        return new Promise((resolve) => {
            setTimeout(resolve, time);
        });
    }
    class Highlighter {
        detecting = false;
        /** @type {Set<Text>} */
        text_nodes = new Set();
        /** @type {Set<Text>} */
        text_nodes_new = new Set();
        matches = [];
        matches_by_blocks = new Map();
        rects_by_blocks = new Map();
        blocks_with_resize_observer = new Set();
        /** @type {string[]} */
        strings = [];
        saturation = 10;
        number_of_matches_all = 0;
        number_of_matches_visible = 0;
        /** @type {HTMLStyleElement} */
        style_main = document.createElement("style");
        constructor() { }
        async init() {
            // init_styles
            this.set_highlight_color('red');
            document.head.append(this.style_main);

            // init_event_listeners
            window.addEventListener("mousedown", (e) => this.handle_user_interaction(), true);
            window.addEventListener("keydown", (e) => this.handle_user_interaction(), true);
            window.addEventListener("wheel", (e) => this.handle_user_interaction(), true);
            window.addEventListener("scroll", (e) => this.handle_user_interaction(), true);
            window.addEventListener("resize", (e) => this.handle_user_interaction(), true);
        }
        /** @param {string} color */
        set_highlight_color(color) {
            this.style_main.innerHTML = `html { --highlight-color: ${color}; }`;
        }
        /**
         * @param {MouseEvent['clientX']} client_x - The x-coordinate of the client point.
         * @param {MouseEvent['clientY']} client_y - The y-coordinate of the client point.
         * @returns { ['word', DOMRect, string] | ['card'] | ['nothing'] } An array containing information about the data at the specified point.
         */
        get_data_from_point(client_x, client_y) {
            let elements = document.elementsFromPoint(client_x, client_y);
            for (let element of elements) {
                console.log('this.matches_by_blocks', this.matches_by_blocks);
                if (this.matches_by_blocks.has(element)) {
                    let matches = this.matches_by_blocks.get(element);
                    for (let match of matches) {
                        let rects = match.range.getClientRects();
                        for (let rect of rects) {
                            if (
                                rect.x < client_x &&
                                rect.y < client_y &&
                                rect.x + rect.width > client_x &&
                                rect.y + rect.height > client_y
                            ) {
                                return ["word", rect, match.string];
                            }
                        }
                    }
                } else if (element.classList.contains("abc")) {
                    return ["card"];
                }
            }
            return ["nothing"];
        }
        /**
         * @param {string[]} all_words 
         * @param {string[]} removed_words 
         */
        restart_detecting(all_words, removed_words, saturation) {
            this.detecting = true;
            let strings = [];
            for (let word of all_words) {
                if (removed_words.includes(word)) {
                } else {
                    strings.push(word);
                }
            }
            this.unpaint_blocks();
            this.text_nodes = new Set();
            this.text_nodes_new = new Set();
            this.matches = [];
            this.matches_by_blocks = new Map();
            this.rects_by_blocks = new Map();
            this.blocks_with_resize_observer = new Set();
            this.strings = strings;
            this.saturation = saturation;
            this.number_of_matches_all = 0;
            this.number_of_matches_visible = 0;
            this.update_text_nodes();
            this.update_matches();
        }
        stop_detecting() {
            this.detecting = false;
            //
            this.unpaint_blocks();
            //
            this.text_nodes = new Set();
            this.text_nodes_new = new Set();
            this.matches = [];
            this.matches_by_blocks = new Map();
            this.rects_by_blocks = new Map();
            this.blocks_with_resize_observer = new Set();
            //
            this.number_of_matches_all = 0;
            this.number_of_matches_visible = 0;
            //
            // this.update_text_nodes();
            // this.update_matches();
            //
        }
        update_text_nodes() {
            /** @type {Text|undefined} */
            let text_node;
            const walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
            while ((text_node = walk.nextNode())) {
                if (this.text_nodes.has(text_node) === false) {
                    this.text_nodes.add(text_node);
                    this.text_nodes_new.add(text_node);
                }
            }
        }

        /**
         * @param {string} str
         * @param {string[]} asl_words
         */
        get_words_with_indexes(str, asl_words) {
            const words = [];
            // match word characters and non-word characters, so that the entire string is divided into
            // parts that put together the entire string
            var match = str.match(/[a-zA-Z0-9\$\&\_\+\-\:\^\.\']+|[^a-zA-Z0-9\$\&\_\+\-\:\^\.\']+/g);
            var index = 0;
            if (match) {
                for (var i = 0; i < match.length; i) {
                    let lowercase_match = match[i].match(/^[a-zA-Z\$\_\+\-\:\^\.]+$/);
                    let number_of_processed_items = 0;
                    if (lowercase_match) {
                        // create multiple options for phrases
                        // with multiple words
                        let option_3;
                        let option_2;
                        let option_1;
                        if (match[i + 4]) {
                            option_3 = match[i] + "-" + match[i + 2] + "-" + match[i + 4];
                            option_3 = option_3.toLowerCase();
                        }
                        if (match[i + 2]) {
                            option_2 = match[i] + "-" + match[i + 2];
                            option_2 = option_2.toLowerCase();
                        }
                        if (match[i]) {
                            option_1 = match[i];
                            option_1 = option_1.toLowerCase();
                        }
                        //
                        let ticker_was_found = false;
                        let ticker_text = "";
                        if (option_3 && asl_words.indexOf(option_3) > -1) {
                            option_3 = option_3.replace(/\.$/, "").toLowerCase();
                            ticker_was_found = true;
                            ticker_text = option_3;
                            number_of_processed_items = 5;
                        } else if (option_2 && asl_words.indexOf(option_2) > -1) {
                            option_2 = option_2.replace(/\.$/, "").toLowerCase();
                            ticker_was_found = true;
                            ticker_text = option_2;
                            number_of_processed_items = 3;
                        } else if (option_1 && asl_words.indexOf(option_1) > -1) {
                            option_1 = option_1.replace(/\.$/, "").toLowerCase();
                            ticker_was_found = true;
                            ticker_text = option_1;
                            number_of_processed_items = 1;
                        } else {
                            number_of_processed_items = 1;
                        }
                        if (ticker_was_found) {
                            words.push({
                                index,
                                text: ticker_text,
                            });
                        }
                    } else {
                        number_of_processed_items = 1;
                    }
                    for (let j = 0; j < number_of_processed_items; j++) {
                        if (match[i]) {
                            index += match[i].length;
                        }
                        i++;
                    }
                }
            }
            return words;
        }

        /** @param {Text} node */
        get_first_block_parent(node) {
            while (true) {
                const parentElement = node.parentElement;
                node = node.parentElement; // TODO: do not mutate node, try to save it in a new variable

                if (!parentElement) return false;

                const display = window.getComputedStyle(parentElement).display;
                if (display === "block") return parentElement;
            }
        }
        update_matches() {
            loop_1: for (let node of this.text_nodes_new) {
                this.text_nodes_new.delete(node);

                let text = node.nodeValue;
                if (!text) return;

                const matches = [];
                const words_with_indexes = this.get_words_with_indexes(text, this.strings);
                if (words_with_indexes && words_with_indexes.length > 0) {
                    const first_block_parent = this.get_first_block_parent(node);
                    if (this.matches_by_blocks.has(first_block_parent) === false) {
                        this.matches_by_blocks.set(first_block_parent, []);
                        let resize_observer = new ResizeObserver(() => {
                            this.paint_block(first_block_parent);
                        });
                        resize_observer.observe(first_block_parent);
                    }
                    loop_2: for (let word of words_with_indexes) {
                        this.number_of_matches_all += 1;
                        if (this.number_of_matches_visible / this.number_of_matches_all <= this.saturation / 10) {
                            this.number_of_matches_visible += 1;
                        } else {
                            continue loop_2;
                        }
                        var range = document.createRange();
                        range.setStart(node, word.index);
                        range.setEnd(node, word.index + word.text.length);
                        let match = {
                            range,
                            index: word.index,
                            node,
                            first_block_parent,
                            string: word.text,
                            start: word.index,
                            end: word.index + word.text.length,
                        };
                        matches.push(match);
                    }
                    if (first_block_parent) {
                        let set = this.matches_by_blocks.get(first_block_parent);
                        for (let match of matches) {
                            this.matches.push(match);
                            set.push(match);
                        }
                        this.paint_block(first_block_parent);
                    }
                }
            }
        }
        async handle_user_interaction() {
            if (this.detecting) {
                this.update_text_nodes();
                this.update_matches();
            }
        }
        unpaint_blocks() {
            for (let block of this.matches_by_blocks.keys()) {
                let block_style = window.getComputedStyle(block);
                if (block_style.background === "rgba(0, 0, 0, 0) paint(signspaces-paint) repeat scroll 0% 0% / auto padding-box border-box") {
                    block.style.setProperty("--signspaces-items", "");
                    block.style.setProperty("background", "");
                }
            }
        }
        get_id() {
            return Date.now().toString(36) + Math.floor(Math.random() * 1_000_000_000_000).toString(36);
        }
        blocks_to_last_repaint_id = new Map();
        async paint_block(block) {
            let matches = this.matches_by_blocks.get(block);
            let this_id = this.get_id();
            this.blocks_to_last_repaint_id.set(block, this_id);
            await wait(50);
            let last_id = this.blocks_to_last_repaint_id.get(block);
            if (this_id === last_id && matches) {
                let rect_1 = block.getBoundingClientRect();
                let block_items = [];
                let rects = [];
                let block_style = window.getComputedStyle(block);
                if (
                    block_style.background === "rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box" ||
                    block_style.background === "rgba(0, 0, 0, 0) paint(signspaces-paint) repeat scroll 0% 0% / auto padding-box border-box"
                ) {
                } else {
                    return;
                }
                for (let match of matches) {
                    try {
                        let rect_2_arr = match.range.getClientRects();
                        for (let rect_2 of rect_2_arr) {
                            let item_x = rect_2.left - rect_1.left;
                            let item_y = rect_2.top - rect_1.top;
                            let item_width = rect_2.width;
                            let item_height = rect_2.height;
                            block_items.push([item_x, item_y, item_width, item_height]);
                            rects.push([rect_2.left, rect_2.y, rect_2.width, rect_2.height, match.string]);
                        }
                    } catch (e) {
                        console.log("error", e);
                    }
                }
                this.rects_by_blocks.set(block, rects);
                block.style.setProperty("--signspaces-items", JSON.stringify(block_items));
                block.style.background = `paint(signspaces-paint)`;
            }
        }
    }

    (async () => {
        const highlighter = new Highlighter();
        await highlighter.init();
        highlighter.set_highlight_color('yellow');
        highlighter.restart_detecting(['hello', 'possimus', 'dolore', 'hi', 'sit'], ['sit'], 10);

        document.addEventListener(
            "mousemove",
            async ({ clientX, clientY }) => {
                const [data_type, rect, string] = highlighter.get_data_from_point(clientX, clientY);
                // console.log({
                //     data_type, rect, string
                // });
                switch (data_type) {
                    case 'word': {
                        console.log('word----------------------');
                        break;
                    }
                    case 'card': {
                        console.log('card----------------------');
                        break;
                    }
                    case 'nothing': {
                        console.log('nothing----------------------');
                        break;
                    }
                    default:
                        break;
                }
            },
            true
        );

        if ("paintWorklet" in CSS) {
            CSS.paintWorklet.addModule("checkboardWorklet.js")
                .then(() => {
                    console.log('OK');
                })
                .catch(() => {
                    console.log('ERROR');
                });
        }
    })();
</script>

</html>